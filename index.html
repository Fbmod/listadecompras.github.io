<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4f46e5"/>
    
    <title>Minha Lista Inteligente</title>
    
    <!-- Estilos e Fontes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; -webkit-tap-highlight-color: transparent; }
        /* Animações */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .spinner { animation: spin 1s linear infinite; border: 3px solid rgba(79, 70, 229, 0.3); border-top-color: #4f46e5; border-radius: 50%; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* Toast Notification */
        .toast { visibility: hidden; opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateY(20px); }
        .toast.show { visibility: visible; opacity: 1; transform: translateY(0); }
    </style>
</head>
<body class="flex items-start justify-center min-h-screen p-2 sm:p-4 text-gray-800">

    <div id="app-container" class="w-full max-w-2xl my-4">
        
        <!-- TELA DE CARREGAMENTO -->
        <div id="loading-screen" class="text-center p-10 mt-10">
            <div class="spinner w-12 h-12 mx-auto"></div>
            <p class="text-gray-600 mt-4">Carregando sua despensa...</p>
        </div>

        <!-- TELA DE LOGIN / CADASTRO -->
        <div id="auth-screen" class="hidden">
            <div class="bg-white rounded-2xl shadow-xl p-6 fade-in border border-gray-100">
                <div class="text-center mb-6">
                    <div class="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-shopping-basket text-3xl text-indigo-600"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-900">Minha Lista</h1>
                    <p class="text-gray-500 text-sm">Organize suas compras sem complicações.</p>
                </div>
                
                <!-- Formulário de Login -->
                <div id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50">
                    <input type="password" id="login-password" placeholder="Senha" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50">
                    <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition shadow-lg shadow-indigo-200">Entrar</button>
                    <p class="text-center text-sm text-gray-500 mt-4">Não tem conta? <a href="#" id="show-register" class="text-indigo-600 font-bold hover:underline">Criar agora</a></p>
                </div>

                <!-- Formulário de Cadastro -->
                <div id="register-form" class="hidden space-y-4">
                    <input type="email" id="reg-email" placeholder="Seu melhor Email" class="w-full px-4 py-3 border border-gray-200 rounded-xl bg-gray-50 focus:outline-none focus:ring-2 focus:ring-teal-500">
                    <input type="password" id="reg-pass" placeholder="Senha (mínimo 6 caracteres)" class="w-full px-4 py-3 border border-gray-200 rounded-xl bg-gray-50 focus:outline-none focus:ring-2 focus:ring-teal-500">
                    <button id="register-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-xl transition shadow-lg shadow-teal-200">Cadastrar</button>
                    <p class="text-center text-sm text-gray-500 mt-4"><a href="#" id="show-login" class="text-indigo-600 font-bold hover:underline">Voltar para Login</a></p>
                </div>
            </div>
        </div>

        <!-- TELA INICIAL (LISTAS) -->
        <div id="home-screen" class="hidden fade-in">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">Suas Listas</h1>
                    <button id="logout-btn" class="text-gray-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
                </div>
                
                <div class="flex gap-2 mb-6">
                    <input type="text" id="new-list-name" placeholder="Ex: Churrasco, Mês..." class="flex-1 px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="add-list-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 rounded-lg transition shadow-md"><i class="fas fa-plus"></i></button>
                </div>

                <div id="lists-container" class="grid gap-3 sm:grid-cols-2">
                    <!-- As listas aparecerão aqui via JavaScript -->
                </div>
                
                <p id="no-lists-msg" class="text-center text-gray-400 mt-8 hidden">Nenhuma lista criada ainda.</p>
            </div>
        </div>

        <!-- TELA DA LISTA (ITENS) -->
        <div id="list-screen" class="hidden fade-in">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 sm:p-6 min-h-[80vh] flex flex-col">
                <!-- Cabeçalho da Lista -->
                <div class="flex items-center gap-3 mb-4 border-b border-gray-100 pb-4">
                    <button id="back-btn" class="text-gray-500 hover:text-indigo-600 hover:bg-gray-100 p-2 rounded-full transition"><i class="fas fa-arrow-left"></i></button>
                    <h1 id="list-title" class="text-xl font-bold flex-1 truncate text-gray-800"></h1>
                    <button id="recipe-btn" class="text-amber-600 bg-amber-50 hover:bg-amber-100 p-2 rounded-lg transition" title="Buscar Ideias de Receitas"><i class="fas fa-utensils"></i></button>
                </div>

                <!-- Campo de Adicionar -->
                <div class="bg-indigo-50 p-4 rounded-xl mb-6 relative border border-indigo-100">
                    <label class="text-[10px] font-bold text-indigo-800 uppercase mb-2 block tracking-wider">Adicionar Itens (IA Local)</label>
                    <div class="flex gap-2">
                        <textarea id="item-input" rows="1" placeholder="Ex: Arroz, feijão e 1kg de carne..." class="w-full px-4 py-3 border-0 rounded-lg focus:ring-2 focus:ring-indigo-500 resize-none shadow-sm"></textarea>
                        <button id="add-item-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 rounded-lg shadow-md transition"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>

                <!-- Lista de Itens -->
                <div id="items-container" class="space-y-4 pb-24 flex-1">
                    <!-- Itens aparecerão aqui -->
                </div>
                <div id="empty-msg" class="text-center py-10 text-gray-300 hidden">
                    <i class="fas fa-clipboard-list text-4xl mb-2"></i>
                    <p>Sua lista está vazia.</p>
                </div>

                <!-- Rodapé com Total -->
                <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 flex justify-between items-center sm:static sm:border-0 sm:mt-4 shadow-lg sm:shadow-none z-10">
                    <div>
                        <span class="text-gray-500 text-xs uppercase font-bold">Total Estimado</span>
                        <div id="total-price" class="text-xl font-bold text-indigo-600">R$ 0,00</div>
                    </div>
                    <button id="clear-checked" class="text-sm text-gray-400 hover:text-red-500 underline transition">Limpar comprados</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST (Notificações) -->
    <div id="toast" class="toast fixed bottom-20 right-1/2 translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl z-50 flex items-center gap-3 whitespace-nowrap">
        <i class="fas fa-check-circle text-green-400"></i><span id="toast-msg" class="font-medium"></span>
    </div>

    <!-- JAVASCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // 1. Dicionário Turbinado
        const categoryDB = {
            'Hortifruti': ['banana', 'maca', 'maçã', 'uva', 'laranja', 'limao', 'limão', 'mamao', 'mamão', 'melancia', 'melao', 'melão', 'abacaxi', 'manga', 'morango', 'pera', 'abacate', 'maracuja', 'maracujá', 'kiwi', 'caqui', 'goiaba', 'pessego', 'pêssego', 'batata', 'cebola', 'tomate', 'cenoura', 'alface', 'alho', 'couve', 'pimentao', 'pimentão', 'abobrinha', 'berinjela', 'chuchu', 'pepino', 'beterraba', 'brocolis', 'brócolis', 'repolho', 'rucula', 'rúcula', 'salsinha', 'cebolinha', 'coentro', 'cheiro verde', 'mandioca', 'aipim', 'macaxeira', 'batata doce', 'inhame', 'quiabo', 'vagem', 'gengibre', 'hortela', 'hortelã', 'manjericao', 'manjericão', 'espinafre', 'milho verde'],
            'Açougue': ['carne', 'bife', 'moida', 'moída', 'picanha', 'alcatra', 'contra file', 'filé', 'acem', 'acém', 'musculo', 'costela', 'figado', 'fígado', 'boi', 'frango', 'peito de frango', 'asa', 'coxa', 'sobrecoxa', 'coracao', 'coração', 'file de frango', 'porco', 'bisteca', 'linguica', 'linguiça', 'salsicha', 'bacon', 'presunto', 'calabresa', 'paio', 'mortadela', 'salame', 'lombo', 'pernil', 'peixe', 'file de peixe', 'camarao', 'camarão', 'sardinha', 'hamburguer', 'empanado', 'nuggets'],
            'Laticínios': ['leite', 'queijo', 'mussarela', 'muçarela', 'prato', 'parmesao', 'parmesão', 'minas', 'ricota', 'catupiry', 'requeijao', 'requeijão', 'iogurte', 'danone', 'yakult', 'manteiga', 'margarina', 'nata', 'creme de leite', 'leite condensado', 'doce de leite', 'chantilly', 'leite fermentado', 'coalhada', 'ovo', 'ovos'],
            'Mercearia': ['arroz', 'feijao', 'feijão', 'macarrao', 'macarrão', 'oleo', 'óleo', 'azeite', 'sal', 'acucar', 'açúcar', 'cafe', 'café', 'farinha', 'fuba', 'fubá', 'milho', 'ervilha', 'pao', 'pão', 'biscoito', 'bolacha', 'torrada', 'cereal', 'aveia', 'granola', 'mel', 'chocolate', 'achocolatado', 'nescau', 'toddy', 'bombom', 'barra de cereal', 'molho', 'extrato', 'pomarola', 'maionese', 'ketchup', 'mostarda', 'vinagre', 'shoyu', 'palmito', 'azeitona', 'cogumelo', 'champignon', 'seleta', 'miojo', 'lamen', 'sopa', 'pipoca', 'gelatina', 'pudim', 'leite de coco', 'creme de cebola', 'tempero', 'pimenta', 'oregano', 'orégano', 'caldo', 'sazon', 'racao', 'ração', 'petisco', 'areia de gato', 'sache', 'sachê'],
            'Padaria': ['pao frances', 'pão francês', 'baguete', 'ciabatta', 'sonho', 'bolo', 'torta', 'pao de queijo', 'pão de queijo', 'salgado', 'coxinha', 'brioche', 'pao de forma'],
            'Bebidas': ['agua', 'água', 'suco', 'refrigerante', 'coca', 'guarana', 'guaraná', 'pepsi', 'fanta', 'cerveja', 'vinho', 'vodka', 'wisky', 'whisky', 'gin', 'cachaca', 'cachaça', 'energetico', 'energético', 'cha', 'chá', 'mate', 'agua de coco', 'tonica', 'tônica'],
            'Limpeza': ['sabao', 'sabão', 'detergente', 'ypê', 'minuano', 'amaciante', 'agua sanitaria', 'água sanitária', 'candida', 'cloro', 'desinfetante', 'veja', 'multiuso', 'alcool', 'álcool', 'esponja', 'bucha', 'bombril', 'lã de aço', 'palha de aço', 'saco de lixo', 'lixeira', 'pano', 'flanela', 'rodo', 'vassoura', 'pa', 'pá', 'sabao em po', 'sabão em pó', 'omo', 'tixan', 'vanish', 'tira manchas', 'lustra moveis'],
            'Higiene': ['papel higienico', 'papel higiênico', 'sabonete', 'shampoo', 'xampu', 'condicionador', 'pasta de dente', 'creme dental', 'escova de dente', 'fio dental', 'enxaguante', 'desodorante', 'perfume', 'hidratante', 'creme', 'protetor solar', 'cotonete', 'algodao', 'algodão', 'absorvente', 'fralda', 'lenco', 'lenço', 'gilete', 'lâmina', 'barbear', 'talco', 'esmalte', 'acetona']
        };

        const detectCategory = (itemName) => {
            const lower = itemName.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            for (const [cat, keywords] of Object.entries(categoryDB)) {
                if (keywords.some(k => lower.includes(k))) return cat;
            }
            return 'Outros';
        };

        // 2. Configuração Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDoyIgr10VEBwpDjNZcdLEDP2yIREW6KKk", 
            authDomain: "lista-de-compras-app-1446f.firebaseapp.com",
            projectId: "lista-de-compras-app-1446f",
            storageBucket: "lista-de-compras-app-1446f.appspot.com",
            messagingSenderId: "417565877000",
            appId: "1:417565877000:web:31f32aa29d9575b1bdc2bd"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Erro Firebase:", e);
            alert("Erro ao conectar no banco de dados.");
        }
        
        let userId = null;
        let currentListId = null;
        let unsubscribe = null;
        let localLists = [];

        // 3. Inicialização e Autenticação
        onAuthStateChanged(auth, user => {
            userId = user ? user.uid : null;
            if(user) {
                switchView('home');
                setupListener();
            } else {
                switchView('auth');
            }
            document.getElementById('loading-screen').classList.add('hidden');
        });

        const setupListener = () => {
            if(unsubscribe) unsubscribe();
            unsubscribe = onSnapshot(collection(db, "artifacts", firebaseConfig.appId, "users", userId, "lists"), snap => {
                localLists = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(currentListId) renderListItems(); else renderLists();
            }, (error) => {
                console.error("Erro listener:", error);
            });
        };

        // 4. Navegação
        const switchView = (screen) => {
            ['auth', 'home', 'list'].forEach(s => document.getElementById(s+'-screen').classList.add('hidden'));
            document.getElementById(screen+'-screen').classList.remove('hidden');
            if(screen === 'home') { currentListId = null; renderLists(); }
        };

        const showToast = (msg) => {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        };

        // 5. Renderização
        const renderLists = () => {
            const container = document.getElementById('lists-container');
            container.innerHTML = '';
            document.getElementById('no-lists-msg').classList.toggle('hidden', localLists.length > 0);

            localLists.forEach(l => {
                const total = l.items?.length || 0;
                const done = l.items?.filter(i => i.checked).length || 0;
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-4 rounded-xl border border-gray-200 hover:border-indigo-400 cursor-pointer transition relative group';
                div.dataset.listId = l.id;
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-gray-800 text-lg">${l.name}</h3>
                        <button class="delete-list-btn text-gray-300 hover:text-red-500 p-2 z-10"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="mt-3 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full bg-indigo-500 transition-all duration-500" style="width: ${total ? (done/total)*100 : 0}%"></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 font-medium">${done}/${total} comprados</p>
                `;
                container.appendChild(div);
            });
        };

        const renderListItems = () => {
            const list = localLists.find(l => l.id === currentListId);
            if(!list) return switchView('home');

            document.getElementById('list-title').textContent = list.name;
            const container = document.getElementById('items-container');
            container.innerHTML = '';
            
            const items = list.items || [];
            document.getElementById('empty-msg').classList.toggle('hidden', items.length > 0);

            const total = items.reduce((acc, i) => i.checked && i.price ? acc + i.price : acc, 0);
            document.getElementById('total-price').textContent = new Intl.NumberFormat('pt-BR', {style:'currency', currency:'BRL'}).format(total);

            const groups = items.reduce((acc, item) => {
                const cat = item.category || 'Outros';
                if(!acc[cat]) acc[cat] = [];
                acc[cat].push(item);
                return acc;
            }, {});

            Object.keys(groups).sort((a,b) => (a==='Outros'?1:(b==='Outros'?-1:a.localeCompare(b)))).forEach(cat => {
                const div = document.createElement('div');
                div.innerHTML = `<h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 mt-4 pl-1 flex items-center gap-2"><i class="fas fa-tag"></i> ${cat}</h3>`;
                const ul = document.createElement('div');
                ul.className = 'space-y-2';
                
                groups[cat].sort((a,b) => (a.checked === b.checked) ? a.name.localeCompare(b.name) : a.checked - b.checked).forEach(item => {
                    const el = document.createElement('div');
                    el.dataset.itemId = item.id;
                    el.className = `item-row flex items-center justify-between p-3 rounded-lg border transition-all ${item.checked ? 'bg-gray-100 border-transparent opacity-60' : 'bg-white border-gray-100 shadow-sm'}`;
                    
                    el.innerHTML = `
                        <div class="flex items-center gap-3 flex-1 cursor-pointer action-check select-none">
                            <div class="w-6 h-6 border-2 rounded-md flex items-center justify-center pointer-events-none transition-colors ${item.checked ? 'bg-indigo-500 border-indigo-500' : 'border-gray-300'}">
                                ${item.checked ? '<i class="fas fa-check text-white text-xs"></i>' : ''}
                            </div>
                            <div class="flex flex-col pointer-events-none min-w-0">
                                <span class="truncate ${item.checked ? 'line-through text-gray-400' : 'text-gray-800 font-medium'}">${item.name}</span>
                                <span class="text-xs text-green-600 font-bold h-4">${item.price ? 'R$ '+item.price.toFixed(2) : ''}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button class="action-price p-2 text-gray-400 hover:text-green-600 transition bg-transparent hover:bg-green-50 rounded-lg"><i class="fas fa-dollar-sign pointer-events-none"></i></button>
                            <button class="action-delete p-2 text-gray-400 hover:text-red-500 transition bg-transparent hover:bg-red-50 rounded-lg"><i class="fas fa-trash pointer-events-none"></i></button>
                        </div>
                    `;
                    ul.appendChild(el);
                });
                div.appendChild(ul);
                container.appendChild(div);
            });
        };

        // 6. Manipuladores de Eventos (DELEGAÇÃO CORRIGIDA)
        
        // Tela Home: Clicar na lista ou apagar lista
        document.getElementById('lists-container').addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.delete-list-btn');
            if (deleteBtn) {
                e.stopPropagation();
                const listEl = deleteBtn.closest('[data-list-id]');
                if (listEl && confirm('Tem certeza que deseja apagar esta lista?')) {
                    await deleteDoc(doc(db, "artifacts", firebaseConfig.appId, "users", userId, "lists", listEl.dataset.listId));
                }
                return;
            }

            const listCard = e.target.closest('[data-list-id]');
            if (listCard) {
                currentListId = listCard.dataset.listId;
                renderListItems();
                switchView('list');
            }
        });

        // Tela Lista: Clicar nos itens, preço, deletar
        document.getElementById('items-container').addEventListener('click', async (e) => {
            const itemRow = e.target.closest('.item-row');
            if (!itemRow) return;

            const itemId = itemRow.dataset.itemId;
            const list = localLists.find(l => l.id === currentListId);
            if (!list) return;

            // Deletar Item
            if (e.target.closest('.action-delete')) {
                if(confirm('Remover item?')) {
                    const updated = list.items.filter(i => i.id != itemId);
                    await updateDoc(doc(db, "artifacts", firebaseConfig.appId, "users", userId, "lists", currentListId), { items: updated });
                }
                return;
            }

            // Preço Item
            if (e.target.closest('.action-price')) {
                const currentItem = list.items.find(i => i.id == itemId);
                const price = prompt("Valor do item (ex: 10.50):", currentItem.price || "");
                if (price !== null) {
                    const val = parseFloat(price.replace(',', '.'));
                    const updated = list.items.map(i => i.id == itemId ? {...i, price: isNaN(val) ? null : val} : i);
                    await updateDoc(doc(db, "artifacts", firebaseConfig.appId, "users", userId, "lists", currentListId), { items: updated });
                }
                return;
            }

            // Check/Uncheck
            if (e.target.closest('.action-check')) {
                const updated = list.items.map(i => i.id == itemId ? {...i, checked: !i.checked} : i);
                await updateDoc(doc(db, "artifacts", firebaseConfig.appId, "users", userId, "lists", currentListId), { items: updated });
            }
        });

        // 7. Funções de Ação
        const handleAddItem = async () => {
            const input = document.getElementById('item-input');
            const text = input.value.trim();
            if(!text) return;

            // Divide por vírgula, 'e', ou nova linha
            const rawItems = text.split(/,|\be\b|\n/).map(s => s.trim()).filter(s => s.length > 0);
            const list = localLists.find(l => l.id === currentListId);
            const currentItems = list.items || [];
            
            const newItems = rawItems.map(rawName => {
                // Limpa quantidades no início (ex: "2kg arroz" -> "arroz") para detectar categoria
                const cleanName = rawName.replace(/^\d+(\w+|\s)*\s+(de\s+)?/i, '');
                return {
                    id: Date.now() + Math.random(),
                    name: rawName.charAt(0).toUpperCase() + rawName.slice(1),
                    category: detectCategory(cleanName),
                    price: null,
                    checked: false
                };
            });

            await updateDoc(doc(db, "artifacts", firebaseConfig.appId, "users", userId, "lists", currentListId), {
                items: [...newItems, ...currentItems]
            });
            input.value = '';
            showToast(`${newItems.length} item(s) adicionado(s)!`);
        };

        // Listeners de Botões Gerais
        document.getElementById('login-btn').onclick = () => signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value).catch(e => alert("Erro no login: " + e.message));
        document.getElementById('register-btn').onclick = () => createUserWithEmailAndPassword(auth, document.getElementById('reg-email').value, document.getElementById('reg-pass').value).catch(e => alert("Erro no cadastro: " + e.message));
        document.getElementById('logout-btn').onclick = () => signOut(auth);
        
        document.getElementById('show-register').onclick = (e) => { e.preventDefault(); document.getElementById('login-form').classList.add('hidden'); document.getElementById('register-form').classList.remove('hidden'); };
        document.getElementById('show-login').onclick = (e) => { e.preventDefault(); document.getElementById('register-form').classList.add('hidden'); document.getElementById('login-form').classList.remove('hidden'); };
        
        document.getElementById('add-list-btn').onclick = async () => {
            const name = document.getElementById('new-list-name').value.trim();
            if(name) {
                await addDoc(collection(db, "artifacts", firebaseConfig.appId, "users", userId, "lists"), { name, items: [] });
                document.getElementById('new-list-name').value = '';
            }
        };
        
        document.getElementById('add-item-btn').onclick = handleAddItem;
        document.getElementById('item-input').onkeydown = (e) => { if(e.key === 'Enter') { e.preventDefault(); handleAddItem(); }};
        document.getElementById('back-btn').onclick = () => switchView('home');
        
        document.getElementById('clear-checked').onclick = async () => {
            if(confirm('Remover itens comprados desta lista?')) {
                const list = localLists.find(l => l.id === currentListId);
                await updateDoc(doc(db, "artifacts", firebaseConfig.appId, "users", userId, "lists", currentListId), { items: list.items.filter(i => !i.checked) });
            }
        };

        document.getElementById('recipe-btn').onclick = () => {
            const list = localLists.find(l => l.id === currentListId);
            const ingredients = list.items.filter(i => !i.checked).map(i => i.name).join(' ');
            if(!ingredients) return showToast("Lista vazia ou tudo comprado!");
            window.open(`https://www.google.com/search?q=receita+com+${encodeURIComponent(ingredients)}`, '_blank');
        };

        console.log("App iniciado.");
    </script>
</body>
</html>
